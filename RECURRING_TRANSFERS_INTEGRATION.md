# שילוב העברות קבועות במערכת העברות התשלום

## סקירה כללית

העברות קבועות משולבות כעת אוטומטית בתהליך העברות התשלום. כאשר מאשרים החזרים למשתמש, ההעברות הקבועות הפעילות שלו מתווספות אוטומטית לסכום ההעברה.

## איך זה עובד?

### דוגמה
אם משתמש הגיש 3 החזרים בסך **100 ₪** וההעברה הקבועה שלו היא **50 ₪**, אז ההעברה שהגזברית המעגלית אמורה להעביר לו תהיה בסך **150 ₪**.

### חישוב סכום ההעברה
```
סכום העברה = סכום החזרים - סכום חיובים + סכום העברות קבועות
```

## שינויים טכניים

### Backend

#### 1. `paymentTransferHelpers.ts`
- **פונקציה**: `updateTransferTotals()`
- **שינוי**: הפונקציה כעת מחשבת את סכום ההעברות הקבועות הפעילות עבור המשתמש ומוסיפה אותן לסכום הכולל
- **התאמת תקציב**: רק העברות קבועות מאותו סוג תקציב (מעגלי/קבוצתי) נכללות בחישוב
- **תנאים**: רק העברות קבועות עם סטטוס `active` ותאריך סיום שלא עבר נכללות

#### 2. `paymentTransferController.ts`
- **פונקציה**: `getPaymentTransferById()`
- **שינוי**: הפונקציה כעת מחזירה גם את רשימת ההעברות הקבועות הפעילות עבור המשתמש
- **מידע נוסף**: כל העברה קבועה כוללת פרטים על הסעיף, התדירות, תאריכי התחלה וסיום

### Frontend

#### 1. `types/index.ts`
- **ממשק**: `PaymentTransferDetails`
- **שינוי**: נוסף שדה `recurringTransfers?: RecurringTransfer[]`

#### 2. `PaymentTransferDetailsModal.tsx`
- **שינוי**: המודל כעת מציג סעיף נפרד להעברות קבועות
- **עיצוב**: העברות קבועות מוצגות בטבלה נפרדת עם צבע סגול (במקום ירוק)
- **הודעה**: הוספה הודעת מידע שמסבירה שהעברות אלו מתווספות אוטומטית

## תכונות

### אוטומציה מלאה
- אין צורך לפעולה ידנית - ההעברות הקבועות מתווספות אוטומטית
- עדכון בזמן אמת של סכומי ההעברות כאשר משנים העברות קבועות

### התאמת תקציב
- העברות קבועות ממעגל מתווספות רק להעברות מעגליות
- העברות קבועות מקבוצה מתווספות רק להעברות קבוצתיות

### שקיפות
- כל ההעברות הקבועות מוצגות בפרטי ההעברה
- ברור למשתמש מה הסכום הכולל שהוא יקבל

## זרימת עבודה

1. **הגשת החזרים**: משתמש מגיש החזרים כרגיל
2. **אישור**: גזבר מאשר את ההחזרים
3. **יצירת העברה**: המערכת יוצרת/מעדכנת העברת תשלום
4. **הוספה אוטומטית**: המערכת מוסיפה אוטומטית את ההעברות הקבועות הפעילות
5. **חישוב סכום**: הסכום הכולל מחושב: החזרים - חיובים + העברות קבועות
6. **ביצוע**: הגזבר מבצע את ההעברה בסכום הכולל

## בדיקות שבוצעו

✅ **העברות קבועות מתווספות אוטומטית** - כאשר מאשרים החזרים, ההעברות הקבועות הפעילות מתווספות לסכום  
✅ **רק העברות קבועות פעילות נכללות** - העברות עם סטטוס 'active' ותאריך סיום תקף  
✅ **התאמת תקציב עובדת** - העברות קבועות מעגליות מתווספות רק להעברות מעגליות  
✅ **העברות קבועות מוצגות במודל** - מוצגות בטבלה עם שאר הפריטים  
✅ **הסכום הכולל מחושב נכון** - החזרים - חיובים + העברות קבועות  
✅ **עדכון בזמן אמת** - שינויים בהעברות קבועות משפיעים על ההעברות הממתינות

## הערות חשובות

- העברות קבועות עם תאריך סיום שעבר לא נכללות בחישוב
- העברות קבועות במצב `paused` או `cancelled` לא נכללות
- שינוי בהעברה קבועה (סכום, סטטוס) משפיע על כל ההעברות הממתינות
- ביצוע העברה לא משפיע על ההעברה הקבועה - היא תמשיך להתווסף להעברות הבאות
