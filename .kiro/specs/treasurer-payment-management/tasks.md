# רשימת משימות - ניהול העברות לגזברים

## סקירה

רשימת משימות זו מתארת את השלבים המדויקים ליישום תכונת ניהול ההעברות לגזברים. כל משימה בנויה על הקודמות ומתמקדת בפונקציונליות ספציפית שניתן לממש ולבדוק באופן עצמאי.

---

## משימות Backend

- [x] 1. הוספת סטטוס "לבדיקה" למערכת









  - יצירת migration להוספת עמודות חדשות לטבלת reimbursements: `under_review_by`, `under_review_at`, `review_notes`
  - עדכון constraint של status להכיל 'under_review'
  - יצירת אינדקסים על status ו-under_review_by
  - _דרישות: 1.1, 1.2, 6.1, 6.2_

- [x] 2. הוספת endpoints לפעולות בודדות על החזרים










  - [x] 2.1 יישום endpoint לסימון החזר בודד לבדיקה (POST /api/reimbursements/:id/mark-review)



    - קבלת notes אופציונלי
    - עדכון status ל-'under_review'
    - שמירת under_review_by ו-under_review_at
    - בדיקת הרשאות גזבר
    - _דרישות: 6.1, 6.5_



  - [x] 2.2 יישום endpoint להחזרת החזר לממתין (POST /api/reimbursements/:id/return-to-pending)


    - שינוי status מ-'under_review' ל-'pending'
    - ניקוי שדות under_review
    - בדיקת הרשאות גזבר
    - _דרישות: 6.4_

- [x] 3. הוספת endpoints לפעולות batch על החזרים






  - [x] 3.1 יישום endpoint לאישור מרובה (POST /api/reimbursements/batch/approve)




    - קבלת מערך של IDs
    - אישור כל ההחזרים בתוך transaction
    - החזרת מידע על הצלחות וכשלונות
    - _דרישות: 5.2, 4.1, 4.2_

  - [x] 3.2 יישום endpoint לדחייה מרובה (POST /api/reimbursements/batch/reject)


    - קבלת מערך של IDs וסיבת דחייה
    - דחיית כל ההחזרים בתוך transaction
    - שמירת סיבת הדחייה בשדה notes
    - _דרישות: 7.3, 4.1, 4.2_

  - [x] 3.3 יישום endpoint לסימון מרובה לבדיקה (POST /api/reimbursements/batch/mark-review)


    - קבלת מערך של IDs והערות אופציונליות
    - עדכון כל ההחזרים בתוך transaction
    - _דרישות: 6.2, 4.1, 4.2_

  - [x] 3.4 יישום endpoint לסימון מרובה כשולם (POST /api/reimbursements/batch/mark-paid)


    - קבלת מערך של IDs
    - עדכון כל ההחזרים בתוך transaction
    - _דרישות: 5.4, 4.1, 4.2_
- [x] 4. יישום endpoint לקבלת כל החזרים מקובצים לפי סטטוס




- [ ] 4. יישום endpoint לקבלת כל החזרים מקובצים לפי סטטוס



  - יצירת GET /api/reimbursements/treasurer/all
  - תמיכה ב-query parameter: groupBy (status/user/fund/none)
  - החזרת אובייקט עם החזרים מקובצים לפי סטטוס: pending, under_review, approved, rejected, paid
  - החזרת summary עם ספירות וסכומים
  - יישום בקרת גישה: גזבר מעגלי רואה הכל, גזבר קבוצתי רואה רק של הקבוצות שלו
  - _דרישות: 1.1, 1.2, 2.1, 2.2, 2.3, 3.1, 3.2, 3.3, 3.4_


- [x] 5. עדכון routes ב-reimbursementRoutes.ts






  - הוספת כל ה-routes החדשים
  - הוספת middleware של requireTreasurer לכל ה-endpoints החדשים
  - _דרישות: 1.3_

## משימות Frontend


- [x] 6. עדכון Types והגדרות






  - עדכון ReimbursementStatus להכיל 'under_review'
  - הוספת שדות חדשים ל-Reimbursement interface
  - יצירת ReimbursementsByStatus interface
  - יצירת GroupByOption type




  - _דרישות: 6.1, 2.1_

- [x] 7. עדכון API Service





  - הוספת פונקציות ל-reimbursementsAPI: getTreasurerAll, markForReview, returnToPending

  - הוספת פונקציות batch: batchMarkForReview, batchApprove, batchReject, batchMarkAsPaid
  - _דרישות: 4.1, 5.1, 6.1, 7.1_

- [x] 8. יצירת רכיב ReimbursementTable





  - [x] 8.1 יצירת מבנה בסיסי של הטבלה


    - יצירת קומפוננטה עם props: reimbursements, status, onSelect, selectedIds, onAction
    - הגדרת עמודות: checkbox, מגיש, מקבל תשלום, קופה, תיאור, סכום, תאריך הוצאה, תאריך הגשה, פעולות
    - רינדור בסיסי של הטבלה עם כל העמודות
    - _דרישות: 9.1, 9.2_

  - [x] 8.2 הוספת פונקציונליות בחירה


    - יישום checkbox לכל שורה
    - יישום "סמן הכל" בכותרת
    - קריאה ל-onSelect עם מערך IDs
    - _דרישות: 4.1, 4.2, 4.3_

  - [x] 8.3 הוספת פונקציונליות מיון


    - הוספת אייקון מיון בכותרות
    - יישום מיון עולה/יורד בלחיצה על כותרת
    - שמירת מצב המיון (עמודה וכיוון)
    - _דרישות: 8.1, 8.2_

  - [x] 8.4 הוספת פונקציונליות סינון


    - הוספת dropdown סינון בכותרות רלוונטיות
    - יישום סינון לפי ערכים נבחרים
    - תמיכה במספר סינונים בו זמנית
    - כפתור "נקה סינונים"
    - _דרישות: 8.3, 8.4, 8.5, 8.6_

  - [x] 8.5 הוספת כפתורי פעולות לכל שורה


    - כפתורים דינמיים לפי סטטוס ההחזר
    - כפתור "קבלה" אם יש receipt_url
    - כפתור "פרטים" לפתיחת מודל
    - _דרישות: 5.1, 7.1, 9.4_

- [x] 9. יצירת רכיב ActionBar







  - יצירת קומפוננטה עם props: selectedCount, totalAmount, availableActions, onAction
  - הצגת מספר נבחרים וסכום כולל
  - הצגת כפתורי פעולה דינמיים לפי availableActions
  - עיצוב sticky למעלה כשיש בחירה
  - _דרישות: 4.4, 5.2, 5.4, 6.2, 7.3_

-

- [x] 10. יצירת רכיב FilterBar





  - יצירת קומפוננטה עם props: groupBy, onGroupByChange
  - הוספת selector עם אפשרויות: הצג הכל / לפי חברים / לפי קופה
  - עיצוב ברור וידידותי

  - _דרישות: 2.1, 2.2, 2.3, 2.4_
-

- [x] 11. יצירת רכיב ReimbursementDetailsModal





  - יצירת מודל להצגת פרטים מלאים
  - הצגת כל שדות ההחזר
  - הצגת מידע על מגיש ומקבל תשלום
  - הצגת היסטוריה (מתי נוצר, מתי אושר, על ידי מי)
  - כפתור לפתיחת קבלה אם קיימת
  - _דרישות: 9.3, 9.4_


- [x] 12. יצירת רכיב RejectionModal




  - יצירת מודל עם שדה טקסט לסיבת דחייה
  - ולידציה שהשדה לא ריק
  - כפתורי אישור וביטול
  - קריאה ל-callback עם סיבת הדחייה
  - _דרישות: 7.1, 7.2, 7.5_


- [x] 13. עדכון דף Payments.tsx - מבנה בסיסי





  - [x] 13.1 הגדרת State ו-Hooks


    - הגדרת PaymentsState עם כל השדות הנדרשים
    - יצירת useState לכל חלקי ה-state
    - יצירת useEffect לטעינת נתונים
    - _דרישות: 1.1, 1.2_

  - [x] 13.2 יישום פונקציית טעינת נתונים


    - קריאה ל-getTreasurerAll
    - טיפול ב-loading state
    - טיפול בשגיאות עם toast
    - _דרישות: 1.1, 1.2_

  - [x] 13.3 יישום לוגיקת בחירה


    - פונקציה לטיפול בבחירת החזרים
    - שמירת IDs נבחרים ב-Set
    - פונקציה לניקוי בחירה
    - _דרישות: 4.1, 4.2, 4.3, 4.5_




-

- [x] 14. עדכון דף Payments.tsx - פעולות




  - [x] 14.1 יישום פונקציית handleAction


    - switch case לכל סוג פעולה
    - קריאה ל-API המתאים
    - רענון נתונים לאחר הצלחה
    - ניקוי בחירה
    - הצגת toast הצלחה/שגיאה
    - _דרישות: 5.1, 5.2, 5.3, 5.4, 5.5_

  - [x] 14.2 יישום פונקציית handleReject

    - פתיחת RejectionModal
    - קבלת סיבת דחייה
    - קריאה ל-batchReject
    - רענון נתונים
    - _דרישות: 7.1, 7.2, 7.3, 7.4_

  - [x] 14.3 יישום פונקציית handleGroupByChange

    - עדכון state של groupBy
    - רענון נתונים עם הפרמטר החדש
    - _דרישות: 2.1, 2.2, 2.3, 2.4_
- [x] 15. עדכון דף Payments.tsx - UI Layout







- [ ] 15. עדכון דף Payments.tsx - UI Layout

  - [x] 15.1 יצירת PageHeader


    - כותרת "ניהול העברות"
    - הצגת סטטיסטיקות כלליות מ-summary
    - עיצוב מושך
    - _דרישות: 1.4, 3.5_


  - [x] 15.2 הוספת FilterBar לדף

    - שילוב הקומפוננטה
    - חיבור ל-state ו-handlers
    - _דרישות: 2.1, 2.2, 2.3_


  - [x] 15.3 הוספת ActionBar לדף (conditional)

    - הצגה רק כאשר יש החזרים נבחרים
    - חישוב availableActions לפי הסטטוסים של הנבחרים
    - חיבור ל-handleAction
    - _דרישות: 4.4, 5.2, 5.4_

  - [x] 15.4 יצירת סקשן טבלת "ממתינים לאישור"


    - כותרת סקשן עם מספר החזרים
    - שילוב ReimbursementTable עם נתוני pending
    - הצגת הודעה אם אין החזרים
    - _דרישות: 3.1, 3.5_


  - [x] 15.5 יצירת סקשן טבלת "לבדיקה"

    - כותרת סקשן עם מספר החזרים
    - שילוב ReimbursementTable עם נתוני under_review
    - הצגת הודעה אם אין החזרים
    - _דרישות: 3.2, 3.5_

  - [x] 15.6 יצירת סקשן טבלת "אושרו"


    - כותרת סקשן עם מספר החזרים
    - שילוב ReimbursementTable עם נתוני approved
    - הצגת הודעה אם אין החזרים
    - _דרישות: 3.3, 3.5_


  - [x] 15.7 יצירת סקשן טבלת "נדחו"

    - כותרת סקשן עם מספר החזרים
    - שילוב ReimbursementTable עם נתוני rejected
    - הצגת הודעה אם אין החזרים
    - הצגת סיבת הדחייה בפרטים
    - _דרישות: 3.4, 3.5, 7.5_


  - [x] 15.8 הוספת Modals לדף

    - שילוב ReimbursementDetailsModal
    - שילוב RejectionModal
    - חיבור ל-state ו-handlers
    - _דרישות: 7.1, 9.4_


- [x] 16. עיצוב וחוויית משתמש






  - [x] 16.1 עיצוב הטבלאות


    - Grid layout רספונסיבי
    - צבעים ברורים לסטטוסים שונים
    - hover effects
    - _דרישות: 9.1_

  - [x] 16.2 עיצוב הכפתורים והפעולות


    - כפתורים ברורים עם אייקונים
    - צבעים מתאימים (ירוק לאישור, אדום לדחייה, וכו')
    - disabled states
    - _דרישות: 5.1, 7.1_

  - [x] 16.3 הוספת אנימציות ומעברים


    - מעברים חלקים בין טבלאות
    - loading states
    - fade in/out למודלים
    - _דרישות: 5.5_

## משימות תיעוד ועדכון



- [x] 19. עדכון קבצי steering ותיעוד






  - [x] 19.1 עדכון product.md


    - הוספת תיאור תכונת ניהול ההעברות
    - הוספת הסבר על סטטוס "לבדיקה"
    - עדכון רשימת התכונות
    - _דרישות: כל הדרישות_

  - [x] 19.2 עדכון structure.md


    - הוספת הרכיבים החדשים למבנה Frontend
    - הוספת ה-endpoints החדשים לרשימת API
    - עדכון תיאור דף Payments
    - _דרישות: כל הדרישות_

  - [x] 19.3 עדכון tech.md (אם נדרש)


    - תיעוד טכנולוגיות או ספריות חדשות שנוספו
    - _דרישות: כל הדרישות_

---

## הערות

- כל משימה בנויה על הקודמות ויש לבצע אותן בסדר
- לאחר כל משימה, יש לוודא שהקוד עובד ואין שגיאות
- יש להשתמש ב-getDiagnostics לבדיקת שגיאות לאחר שינויי קוד
- כל הטקסטים והודעות צריכים להיות בעברית
- פורמט תאריכים: DD/MM/YY
- אין צורך בכתיבת טסטים
